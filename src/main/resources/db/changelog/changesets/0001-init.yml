databaseChangeLog:
  - changeSet:
      id: 0001-init
      author: system
      changes:
        - createTable:
            tableName: organizations
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: name, type: VARCHAR(180), constraints: { nullable: false } }
              - column: { name: status, type: VARCHAR(40) }
              - column: { name: plan_code, type: VARCHAR(60) }
              - column: { name: plan_started_at, type: TIMESTAMPTZ }
              - column: { name: plan_expires_at, type: TIMESTAMPTZ }
              - column: { name: billing_contact_email, type: VARCHAR(150) }
              - column: { name: billing_cycle, type: VARCHAR(40) }
              - column: { name: billing_currency, type: VARCHAR(10) }
              - column: { name: created_at, type: TIMESTAMPTZ, constraints: { nullable: false } }
              - column: { name: updated_at, type: TIMESTAMPTZ, constraints: { nullable: false } }
        - addUniqueConstraint:
            tableName: organizations
            columnNames: name
            constraintName: uq_org_name
        - createTable:
            tableName: users
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: org_id, type: UUID }
              - column: { name: email, type: VARCHAR(150), constraints: { nullable: false } }
              - column: { name: password_hash, type: VARCHAR(200) }
              - column: { name: display_name, type: VARCHAR(150) }
              - column: { name: is_supervisor, type: BOOLEAN }
              - column: { name: supervisor_pin_hash, type: VARCHAR(200) }
              - column: { name: last_login_at, type: TIMESTAMPTZ }
              - column: { name: status, type: VARCHAR(40) }
              - column: { name: created_at, type: TIMESTAMPTZ, constraints: { nullable: false } }
              - column: { name: updated_at, type: TIMESTAMPTZ, constraints: { nullable: false } }
        - addUniqueConstraint:
            tableName: users
            columnNames: email
            constraintName: uq_users_email
        - createTable:
            tableName: user_roles
            columns:
              - column: { name: user_id, type: UUID, constraints: { nullable: false } }
              - column: { name: role, type: VARCHAR(60), constraints: { nullable: false } }
        - addPrimaryKey:
            tableName: user_roles
            columnNames: user_id, role
            constraintName: pk_user_roles
        - createTable:
            tableName: orders
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: seller_id, type: VARCHAR(100), constraints: { nullable: false } }
              - column: { name: platform_order_id, type: VARCHAR(120), constraints: { nullable: false } }
              - column: { name: order_date, type: TIMESTAMPTZ }
              - column: { name: platform, type: VARCHAR(40), constraints: { nullable: false } }
              - column: { name: status, type: VARCHAR(40) }
              - column: { name: created_at, type: TIMESTAMPTZ, constraints: { nullable: false } }
              - column: { name: updated_at, type: TIMESTAMPTZ, constraints: { nullable: false } }
        - addUniqueConstraint:
            tableName: orders
            columnNames: seller_id, platform_order_id
            constraintName: uq_seller_platform_order
        - createTable:
            tableName: packages
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: package_code, type: VARCHAR(120), constraints: { nullable: false } }
              - column: { name: packer_id, type: UUID }
              - column: { name: order_id, type: UUID, constraints: { nullable: false } }
        - addUniqueConstraint:
            tableName: packages
            columnNames: package_code
            constraintName: uq_packages_code
        - addForeignKeyConstraint:
            baseTableName: users
            baseColumnNames: org_id
            referencedTableName: organizations
            referencedColumnNames: id
            constraintName: fk_user_org
            onDelete: SET NULL
        - addForeignKeyConstraint:
            baseTableName: packages
            baseColumnNames: order_id
            referencedTableName: orders
            referencedColumnNames: id
            constraintName: fk_package_order
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            constraintName: fk_user_roles_user
            onDelete: CASCADE

